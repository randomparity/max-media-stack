---
- name: Verify
  hosts: all
  become: true
  tasks:
    - name: Check config directory exists
      ansible.builtin.stat:
        path: /home/mms/config/open-notebook
      register: open_notebook_config_dir
      failed_when: not open_notebook_config_dir.stat.exists

    - name: Check data directory exists
      ansible.builtin.stat:
        path: /home/mms/config/open-notebook/data
      register: open_notebook_data_dir
      failed_when: not open_notebook_data_dir.stat.exists

    - name: Check SurrealDB data directory exists
      ansible.builtin.stat:
        path: /home/mms/config/open-notebook-db
      register: open_notebook_db_dir
      failed_when: not open_notebook_db_dir.stat.exists

    - name: Check app env file permissions
      ansible.builtin.stat:
        path: /home/mms/config/open-notebook/open-notebook.env
      register: open_notebook_app_env
      failed_when: not open_notebook_app_env.stat.exists or open_notebook_app_env.stat.mode != '0600'

    - name: Check db env file permissions
      ansible.builtin.stat:
        path: /home/mms/config/open-notebook/open-notebook-db.env
      register: open_notebook_db_env
      failed_when: not open_notebook_db_env.stat.exists or open_notebook_db_env.stat.mode != '0600'

    - name: Read app env file
      ansible.builtin.slurp:
        src: /home/mms/config/open-notebook/open-notebook.env
      register: open_notebook_app_env_content

    - name: Verify app env file content
      ansible.builtin.assert:
        that:
          - "'SURREAL_URL=ws://open-notebook-db:8000/rpc' in open_notebook_app_env_decoded"
          - "'SURREAL_USER=root' in open_notebook_app_env_decoded"
          - "'SURREAL_PASSWORD=test-db-password' in open_notebook_app_env_decoded"
          - "'OPEN_NOTEBOOK_ENCRYPTION_KEY=test-encryption-key' in open_notebook_app_env_decoded"
          - "'API_URL=http://notebook.media.example.com' in open_notebook_app_env_decoded"
          - "'TZ=America/New_York' in open_notebook_app_env_decoded"
      vars:
        open_notebook_app_env_decoded: "{{ open_notebook_app_env_content.content | b64decode }}"

    - name: Read db env file
      ansible.builtin.slurp:
        src: /home/mms/config/open-notebook/open-notebook-db.env
      register: open_notebook_db_env_content

    - name: Verify db env file content
      ansible.builtin.assert:
        that:
          - "'SURREAL_USER=root' in open_notebook_db_env_decoded"
          - "'SURREAL_PASS=test-db-password' in open_notebook_db_env_decoded"
          - "'SURREAL_EXPERIMENTAL_GRAPHQL=true' in open_notebook_db_env_decoded"
      vars:
        open_notebook_db_env_decoded: "{{ open_notebook_db_env_content.content | b64decode }}"

    - name: Check app container quadlet file exists
      ansible.builtin.stat:
        path: /home/mms/.config/containers/systemd/open-notebook.container
      register: open_notebook_app_quadlet
      failed_when: not open_notebook_app_quadlet.stat.exists

    - name: Read app container quadlet
      ansible.builtin.slurp:
        src: /home/mms/.config/containers/systemd/open-notebook.container
      register: open_notebook_app_quadlet_content

    - name: Verify app container quadlet content
      ansible.builtin.assert:
        that:
          - "'ContainerName=open-notebook' in open_notebook_app_quadlet_decoded"
          - "'After=open-notebook-db.service' in open_notebook_app_quadlet_decoded"
          - "'UserNS=keep-id' in open_notebook_app_quadlet_decoded"
          - "'Volume=/home/mms/config/open-notebook/data:/app/data:Z' in open_notebook_app_quadlet_decoded"
          - "'Tmpfs=/run:U' in open_notebook_app_quadlet_decoded"
      vars:
        open_notebook_app_quadlet_decoded: "{{ open_notebook_app_quadlet_content.content | b64decode }}"

    - name: Check db container quadlet file exists
      ansible.builtin.stat:
        path: /home/mms/.config/containers/systemd/open-notebook-db.container
      register: open_notebook_db_quadlet
      failed_when: not open_notebook_db_quadlet.stat.exists

    - name: Read db container quadlet
      ansible.builtin.slurp:
        src: /home/mms/.config/containers/systemd/open-notebook-db.container
      register: open_notebook_db_quadlet_content

    - name: Verify db container quadlet content
      ansible.builtin.assert:
        that:
          - "'ContainerName=open-notebook-db' in open_notebook_db_quadlet_decoded"
          - "'Volume=/home/mms/config/open-notebook-db:/mydata:Z' in open_notebook_db_quadlet_decoded"
          - "'UserNS=keep-id:uid=65532,gid=65532' in open_notebook_db_quadlet_decoded"
          - "'Tmpfs=/run:U' in open_notebook_db_quadlet_decoded"
      vars:
        open_notebook_db_quadlet_decoded: "{{ open_notebook_db_quadlet_content.content | b64decode }}"
