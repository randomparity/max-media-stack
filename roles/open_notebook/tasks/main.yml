---
- name: Create Open Notebook config directory
  ansible.builtin.file:
    path: "{{ open_notebook_config_dir }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Create Open Notebook data directory
  ansible.builtin.file:
    path: "{{ open_notebook_config_dir }}/data"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Create SurrealDB data directory
  ansible.builtin.file:
    path: "{{ open_notebook_db_dir }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Deploy SurrealDB environment file
  ansible.builtin.template:
    src: open-notebook-db.env.j2
    dest: "{{ open_notebook_config_dir }}/open-notebook-db.env"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  no_log: true
  notify: Restart open-notebook-db

- name: Deploy Open Notebook environment file
  ansible.builtin.template:
    src: open-notebook.env.j2
    dest: "{{ open_notebook_config_dir }}/open-notebook.env"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  no_log: true
  notify: Restart open-notebook

- name: Deploy SurrealDB container quadlet
  ansible.builtin.template:
    src: open-notebook-db.container.j2
    dest: "{{ mms_quadlet_dir }}/open-notebook-db.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart open-notebook-db

- name: Deploy Open Notebook container quadlet
  ansible.builtin.template:
    src: open-notebook.container.j2
    dest: "{{ mms_quadlet_dir }}/open-notebook.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart open-notebook

# Pull images before starting services to avoid systemd timeout on first boot
- name: Check if Open Notebook images are present
  ansible.builtin.command:
    cmd: "podman image exists {{ item }}"
  loop:
    - "{{ open_notebook_db_image }}"
    - "{{ open_notebook_app_image }}"
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  register: _open_notebook_images
  changed_when: false
  failed_when: false
  check_mode: false

- name: Pull missing Open Notebook images
  ansible.builtin.command:
    cmd: "podman pull {{ item.item }}"
  loop: "{{ _open_notebook_images.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.rc != 0
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  changed_when: true
  timeout: 1800

# Flush handlers to ensure daemon-reload happens before starting services
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

# Enable and start services in dependency order
- name: Enable and start SurrealDB
  ansible.builtin.systemd:
    name: open-notebook-db.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for SurrealDB to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run open-notebook-db
  register: _open_notebook_db_health
  until: _open_notebook_db_health.rc == 0
  retries: 12
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode

- name: Enable and start Open Notebook
  ansible.builtin.systemd:
    name: open-notebook.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Open Notebook health check
  ansible.builtin.command:
    cmd: podman healthcheck run open-notebook
  register: _open_notebook_health
  until: _open_notebook_health.rc == 0
  retries: 18
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode
