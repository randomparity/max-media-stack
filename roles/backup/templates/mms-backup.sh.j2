#!/usr/bin/env bash
# {{ ansible_managed }}
# MMS Backup Script - Handles stop/backup/start/encrypt/retention for all services
set -euo pipefail

BACKUP_DIR="{{ backup_dir }}"
CONFIG_DIR="{{ backup_config_dir }}"
DATE=$(date +%Y-%m-%d)
AGE_KEY="{{ backup_age_public_key }}"
DRY_RUN="${DRY_RUN:-false}"

# Parse CLI flags
for arg in "$@"; do
    case "$arg" in
        --dry-run) DRY_RUN=true ;;
    esac
done

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

backup_arr() {
    local service="$1"
    log "Backing up ${service} (arr)..."
    local dest="${BACKUP_DIR}/${service}/${service}-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    log "Stopping ${service}..."
    systemctl --user stop "${service}" || true

    tar -cf - -C "${CONFIG_DIR}" "${service}" | zstd -T0 -o "$dest"

    log "Starting ${service}..."
    systemctl --user start "${service}"

    encrypt_file "$dest"
    log "${service} backup complete"
}

backup_sabnzbd() {
    log "Backing up sabnzbd..."
    local dest="${BACKUP_DIR}/sabnzbd/sabnzbd-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    tar -cf - -C "${CONFIG_DIR}/sabnzbd" sabnzbd.ini admin | zstd -T0 -o "$dest"

    encrypt_file "$dest"
    log "sabnzbd backup complete"
}

backup_jellyfin() {
    log "Backing up jellyfin..."
    local dest="${BACKUP_DIR}/jellyfin/jellyfin-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    log "Stopping jellyfin..."
    systemctl --user stop jellyfin || true

    tar -cf - -C "${CONFIG_DIR}" --exclude='jellyfin/cache' jellyfin | zstd -T0 -o "$dest"

    log "Starting jellyfin..."
    systemctl --user start jellyfin

    encrypt_file "$dest"
    log "jellyfin backup complete"
}

backup_traefik() {
    log "Backing up traefik..."
    local dest="${BACKUP_DIR}/traefik/traefik-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    tar -cf - -C "${CONFIG_DIR}" traefik | zstd -T0 -o "$dest"

    encrypt_file "$dest"
    log "traefik backup complete"
}

backup_immich() {
    log "Backing up immich..."
    local db_dest="${BACKUP_DIR}/immich/immich-db-${DATE}.sql.zst"
    local config_dest="${BACKUP_DIR}/immich/immich-config-${DATE}.tar.zst"

    # Hot database dump (no downtime)
    if [[ ! -f "$db_dest" && ! -f "${db_dest}.age" ]]; then
        log "Dumping immich PostgreSQL database..."
        podman exec {{ backup_immich_db_container }} pg_dumpall -U postgres | zstd -T0 -o "$db_dest"
        encrypt_file "$db_dest"
    fi

    # Config backup
    if [[ ! -f "$config_dest" && ! -f "${config_dest}.age" ]]; then
        tar -cf - -C "${CONFIG_DIR}" --exclude='{{ backup_immich_media_exclude }}' immich | zstd -T0 -o "$config_dest"
        encrypt_file "$config_dest"
    fi

    # Rsync photos (separate, not compressed/encrypted - too large)
    log "Syncing immich photos..."
    rsync -a --delete "{{ backup_immich_photos_dir }}/" "${BACKUP_DIR}/immich/photos/"

    log "immich backup complete"
}

encrypt_file() {
    local file="$1"
    if [[ -n "$AGE_KEY" && -f "$file" ]]; then
        log "Encrypting ${file}..."
        age -r "$AGE_KEY" -o "${file}.age" "$file"
        rm -f "$file"
    fi
}

prune_tier() {
    local tier="$1"
    local keep="$2"
    shift 2
    local files=("$@")
    local count={% raw %}${#files[@]}{% endraw %}

    if (( count <= keep )); then
        log "  ${tier}: ${count} backups, keeping all (limit: ${keep})"
        return
    fi

    log "  ${tier}: ${count} backups, keeping ${keep}, pruning $(( count - keep ))"
    for (( i = keep; i < count; i++ )); do
        if [[ "$DRY_RUN" == "true" ]]; then
            log "  [dry-run] Would remove: ${files[$i]}"
        else
            log "  Removing: ${files[$i]}"
            rm -f "${files[$i]}"
        fi
    done
}

apply_retention() {
    local service="$1"
    local dir="${BACKUP_DIR}/${service}"
    local monthly=() weekly=() daily=()

    log "Applying retention policy for ${service}..."

    # Collect and classify backup files by date extracted from filename
    while IFS= read -r f; do
        # Extract YYYY-MM-DD from filename (matches service-YYYY-MM-DD. or immich-db-YYYY-MM-DD.)
        local fname
        fname=$(basename "$f")
        local file_date
        file_date=$(echo "$fname" | grep -oP '\d{4}-\d{2}-\d{2}')
        [[ -z "$file_date" ]] && continue

        local day dow
        day=${file_date##*-}

        # Classify: day 01 → monthly, Sunday → weekly, else → daily
        # Use date to get day-of-week (0=Sunday)
        dow=$(date -d "${file_date}" +%w 2>/dev/null || date -j -f "%Y-%m-%d" "${file_date}" +%w)
        if [[ "$day" == "01" ]]; then
            monthly+=("$f")
        elif [[ "$dow" == "0" ]]; then
            weekly+=("$f")
        else
            daily+=("$f")
        fi
    done < <(find "$dir" -maxdepth 1 -type f \( -name '*.tar.zst' -o -name '*.tar.zst.age' -o -name '*.sql.zst' -o -name '*.sql.zst.age' \) | sort -r)

    [[ {% raw %}${#daily[@]}{% endraw %} -gt 0 ]] && prune_tier "daily" {{ backup_retention_daily }} "${daily[@]}"
    [[ {% raw %}${#weekly[@]}{% endraw %} -gt 0 ]] && prune_tier "weekly" {{ backup_retention_weekly }} "${weekly[@]}"
    [[ {% raw %}${#monthly[@]}{% endraw %} -gt 0 ]] && prune_tier "monthly" {{ backup_retention_monthly }} "${monthly[@]}"
}

# Ensure backup directories exist
{% for svc in mms_services + ['traefik', 'immich'] %}
mkdir -p "${BACKUP_DIR}/{{ svc }}"
{% endfor %}

# Run backups
log "=== MMS Backup Starting ==="

{% for svc in mms_services %}
{% if svc == 'sabnzbd' %}
backup_sabnzbd
{% elif svc == 'jellyfin' %}
backup_jellyfin
{% else %}
backup_arr "{{ svc }}"
{% endif %}
{% endfor %}

backup_traefik

backup_immich

# Apply retention
{% for svc in mms_services + ['immich', 'traefik'] %}
apply_retention "{{ svc }}"
{% endfor %}

log "=== MMS Backup Complete ==="
