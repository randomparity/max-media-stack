#!/usr/bin/env bash
# {{ ansible_managed }}
# MMS Backup Script - Handles stop/backup/start/encrypt/retention for all services
set -euo pipefail

BACKUP_DIR="{{ backup_dir }}"
CONFIG_DIR="{{ backup_config_dir }}"
DATE=$(date +%Y-%m-%d)
AGE_KEY="{{ backup_age_public_key }}"

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

backup_arr() {
    local service="$1"
    log "Backing up ${service} (arr)..."
    local dest="${BACKUP_DIR}/${service}/${service}-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    log "Stopping ${service}..."
    systemctl --user stop "${service}" || true

    tar -cf - -C "${CONFIG_DIR}" "${service}" | zstd -T0 -o "$dest"

    log "Starting ${service}..."
    systemctl --user start "${service}"

    encrypt_file "$dest"
    log "${service} backup complete"
}

backup_sabnzbd() {
    log "Backing up sabnzbd..."
    local dest="${BACKUP_DIR}/sabnzbd/sabnzbd-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    tar -cf - -C "${CONFIG_DIR}/sabnzbd" sabnzbd.ini admin | zstd -T0 -o "$dest"

    encrypt_file "$dest"
    log "sabnzbd backup complete"
}

backup_jellyfin() {
    log "Backing up jellyfin..."
    local dest="${BACKUP_DIR}/jellyfin/jellyfin-${DATE}.tar.zst"
    [[ -f "$dest" || -f "${dest}.age" ]] && { log "Backup already exists, skipping"; return 0; }

    log "Stopping jellyfin..."
    systemctl --user stop jellyfin || true

    tar -cf - -C "${CONFIG_DIR}" --exclude='jellyfin/cache' jellyfin | zstd -T0 -o "$dest"

    log "Starting jellyfin..."
    systemctl --user start jellyfin

    encrypt_file "$dest"
    log "jellyfin backup complete"
}

backup_immich() {
    log "Backing up immich..."
    local db_dest="${BACKUP_DIR}/immich/immich-db-${DATE}.sql.zst"
    local config_dest="${BACKUP_DIR}/immich/immich-config-${DATE}.tar.zst"

    # Hot database dump (no downtime)
    if [[ ! -f "$db_dest" && ! -f "${db_dest}.age" ]]; then
        log "Dumping immich PostgreSQL database..."
        podman exec {{ backup_immich_db_container }} pg_dumpall -U postgres | zstd -T0 -o "$db_dest"
        encrypt_file "$db_dest"
    fi

    # Config backup
    if [[ ! -f "$config_dest" && ! -f "${config_dest}.age" ]]; then
        tar -cf - -C "${CONFIG_DIR}" immich | zstd -T0 -o "$config_dest"
        encrypt_file "$config_dest"
    fi

    # Rsync photos (separate, not compressed/encrypted - too large)
    log "Syncing immich photos..."
    rsync -a --delete "{{ backup_immich_photos_dir }}/" "${BACKUP_DIR}/immich/photos/"

    log "immich backup complete"
}

encrypt_file() {
    local file="$1"
    if [[ -n "$AGE_KEY" && -f "$file" ]]; then
        log "Encrypting ${file}..."
        age -r "$AGE_KEY" -o "${file}.age" "$file"
        rm -f "$file"
    fi
}

apply_retention() {
    local service="$1"
    local dir="${BACKUP_DIR}/${service}"
    local monthly_cutoff daily_cutoff

    daily_cutoff=$(date -d "-{{ backup_retention_daily }} days" +%s 2>/dev/null || date -v-{{ backup_retention_daily }}d +%s)
    monthly_cutoff=$(date -d "-{{ backup_retention_monthly * 30 }} days" +%s 2>/dev/null || date -v-{{ backup_retention_monthly * 30 }}d +%s)

    log "Applying retention policy for ${service}..."
    find "$dir" -maxdepth 1 -type f \( -name '*.tar.zst' -o -name '*.tar.zst.age' -o -name '*.sql.zst' -o -name '*.sql.zst.age' \) | while read -r f; do
        file_age=$(stat -c %Y "$f" 2>/dev/null || stat -f %m "$f")
        if (( file_age < monthly_cutoff )); then
            log "Removing old backup: $f"
            rm -f "$f"
        fi
    done
}

# Ensure backup directories exist
for svc in prowlarr radarr sonarr lidarr sabnzbd jellyfin immich; do
    mkdir -p "${BACKUP_DIR}/${svc}"
done

# Run backups
log "=== MMS Backup Starting ==="

{% for svc in mms_services %}
{% if svc == 'sabnzbd' %}
backup_sabnzbd
{% elif svc == 'jellyfin' %}
backup_jellyfin
{% else %}
backup_arr "{{ svc }}"
{% endif %}
{% endfor %}

backup_immich

# Apply retention
{% for svc in mms_services + ['immich'] %}
apply_retention "{{ svc }}"
{% endfor %}

log "=== MMS Backup Complete ==="
