---
# Backup Immich (hot database dump, no downtime)

- name: "immich - Dump PostgreSQL database"
  ansible.builtin.command:
    cmd: >-
      podman exec {{ backup_immich_db_container }}
      pg_dumpall -U postgres
  register: _immich_db_dump
  changed_when: false

- name: "immich - Write database dump to file"
  ansible.builtin.copy:
    content: "{{ _immich_db_dump.stdout }}"
    dest: "{{ backup_dir }}/immich/immich-db-{{ ansible_date_time.date }}.sql"
    owner: "{{ backup_user }}"
    group: "{{ backup_user }}"
    mode: "0640"

- name: "immich - Compress database dump"
  ansible.builtin.command:
    cmd: >-
      zstd -T0 --rm -f
      {{ backup_dir }}/immich/immich-db-{{ ansible_date_time.date }}.sql
      -o {{ backup_dir }}/immich/immich-db-{{ ansible_date_time.date }}.sql.zst
    creates: "{{ backup_dir }}/immich/immich-db-{{ ansible_date_time.date }}.sql.zst"

- name: "immich - Backup config directory"
  ansible.builtin.shell:
    cmd: >-
      tar -cf - -C {{ backup_config_dir }} immich
      | zstd -T0 -o {{ backup_dir }}/immich/immich-config-{{ ansible_date_time.date }}.tar.zst
    creates: "{{ backup_dir }}/immich/immich-config-{{ ansible_date_time.date }}.tar.zst"

- name: "immich - Rsync photos to backup location"
  ansible.builtin.command:
    cmd: >-
      rsync -a --delete
      {{ backup_immich_photos_dir }}/
      {{ backup_dir }}/immich/photos/
  changed_when: false
