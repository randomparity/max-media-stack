#!/bin/bash
# Managed by Ansible - do not edit
# Configure Tailscale serve mappings for MMS services

set -euo pipefail

CHANGED=false

{% for service, port in tailscale_serve_mappings.items() %}
# Configure {{ service }} on HTTPS port {{ port }}
if ! tailscale serve status 2>/dev/null | grep -q ":{{ port }}"; then
    tailscale serve --bg --https={{ port }} http://localhost:{{ tailscale_local_ports[service] | default(port) }}
    CHANGED=true
    echo "{{ service }} configured on https:{{ port }}"
fi
{% endfor %}

if [ "$CHANGED" = true ]; then
    echo "Tailscale serve configured"
else
    echo "Tailscale serve already up to date"
fi
