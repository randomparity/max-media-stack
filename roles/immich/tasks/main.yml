---
- name: Create Immich config directory
  ansible.builtin.file:
    path: "{{ mms_config_dir }}/immich"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Check if Immich DB password secret exists
  ansible.builtin.command:
    cmd: podman secret inspect immich-db-password
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  register: _immich_secret_inspect
  changed_when: false
  failed_when: false
  check_mode: false

- name: Compute desired password hash
  ansible.builtin.set_fact:
    _immich_db_password_hash: "{{ vault_immich_db_password | hash('sha256') }}"
  no_log: true

- name: Read stored password hash
  ansible.builtin.slurp:
    src: "{{ mms_config_dir }}/immich/.db-password.sha256"
  become: true
  register: _immich_stored_hash
  failed_when: false

- name: Determine if secret needs update
  ansible.builtin.set_fact:
    _immich_secret_needs_update: >-
      {{ (_immich_secret_inspect.rc != 0
          or _immich_stored_hash is failed
          or (_immich_stored_hash.content | default('') | b64decode | trim) != _immich_db_password_hash) | bool }}

- name: Remove existing secret
  ansible.builtin.command:
    cmd: podman secret rm immich-db-password
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: (_immich_secret_needs_update | bool) and _immich_secret_inspect.rc == 0
  no_log: true

- name: Create Immich DB password secret
  ansible.builtin.shell:
    cmd: printf '%s' "$IMMICH_DB_PASSWORD" | podman secret create immich-db-password -
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env | combine({'IMMICH_DB_PASSWORD': vault_immich_db_password}) }}"
  when: _immich_secret_needs_update | bool
  no_log: true

- name: Store password hash
  ansible.builtin.copy:
    content: "{{ _immich_db_password_hash }}\n"
    dest: "{{ mms_config_dir }}/immich/.db-password.sha256"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  when: _immich_secret_needs_update | bool

- name: Deploy Immich environment file
  ansible.builtin.template:
    src: immich.env.j2
    dest: "{{ mms_config_dir }}/immich/immich.env"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  notify:
    - Restart immich-server
    - Restart immich-ml

# Volume quadlets
- name: Deploy immich-pgdata volume quadlet
  ansible.builtin.template:
    src: immich-pgdata.volume.j2
    dest: "{{ mms_quadlet_dir }}/immich-pgdata.volume"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify: Reload systemd user daemon

- name: Deploy immich-redis volume quadlet
  ansible.builtin.template:
    src: immich-redis.volume.j2
    dest: "{{ mms_quadlet_dir }}/immich-redis.volume"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify: Reload systemd user daemon

- name: Deploy immich-ml-cache volume quadlet
  ansible.builtin.template:
    src: immich-ml-cache.volume.j2
    dest: "{{ mms_quadlet_dir }}/immich-ml-cache.volume"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify: Reload systemd user daemon

# Container quadlets
- name: Deploy immich-postgres container quadlet
  ansible.builtin.template:
    src: immich-postgres.container.j2
    dest: "{{ mms_quadlet_dir }}/immich-postgres.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart immich-postgres

- name: Deploy immich-redis container quadlet
  ansible.builtin.template:
    src: immich-redis.container.j2
    dest: "{{ mms_quadlet_dir }}/immich-redis.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart immich-redis

- name: Deploy immich-server container quadlet
  ansible.builtin.template:
    src: immich-server.container.j2
    dest: "{{ mms_quadlet_dir }}/immich-server.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart immich-server

- name: Deploy ML health check script
  ansible.builtin.template:
    src: healthcheck-ml.sh.j2
    dest: "{{ mms_config_dir }}/immich/healthcheck-ml.sh"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Deploy immich-ml container quadlet
  ansible.builtin.template:
    src: immich-ml.container.j2
    dest: "{{ mms_quadlet_dir }}/immich-ml.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart immich-ml

# Pull images before starting services to avoid systemd timeout on first boot
- name: Check if Immich images are present
  ansible.builtin.command:
    cmd: "podman image exists {{ item }}"
  loop:
    - "{{ immich_postgres_image }}"
    - "{{ immich_redis_image }}"
    - "{{ immich_server_image }}"
    - "{{ immich_ml_image }}"
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  register: _immich_images
  changed_when: false
  failed_when: false
  check_mode: false

- name: Pull missing Immich images
  ansible.builtin.command:
    cmd: "podman pull {{ item.item }}"
  loop: "{{ _immich_images.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.rc != 0
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  changed_when: true
  timeout: 1800

# One-time migration: move generated content from NFS to local SSD
- name: Check for legacy NFS layout (generated dirs still on NFS)
  ansible.builtin.stat:
    path: "{{ immich_upload_dir }}/{{ item }}"
  loop: "{{ immich_local_dirs }}"
  register: _immich_legacy_dirs

- name: Migrate generated content from NFS to local SSD
  when: _immich_legacy_dirs.results | selectattr('stat.exists') | list | length > 0
  block:
    - name: Stop Immich services for migration
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        scope: user
      loop:
        - immich-ml.service
        - immich-server.service
      become: true
      become_user: "{{ mms_user }}"
      environment: "{{ mms_systemd_env }}"
      failed_when: false

    - name: Ensure local media directory exists for migration
      ansible.builtin.file:
        path: "{{ immich_media_dir }}"
        state: directory
        owner: "{{ mms_user }}"
        group: "{{ mms_user }}"
        mode: "0755"
      become: true

    - name: Rsync generated directories from NFS to local SSD  # noqa: command-instead-of-module
      ansible.builtin.command:
        cmd: >-
          rsync -a --remove-source-files
          {{ immich_upload_dir }}/{{ item }}/
          {{ immich_media_dir }}/{{ item }}/
        creates: "{{ immich_media_dir }}/{{ item }}/.immich"
      loop: "{{ immich_local_dirs }}"
      become: true
      become_user: "{{ mms_user }}"

    - name: Remove empty source directories after migration
      ansible.builtin.file:
        path: "{{ immich_upload_dir }}/{{ item }}"
        state: absent
      loop: "{{ immich_local_dirs }}"
      become: true
      become_user: "{{ mms_user }}"
  rescue:
    - name: Log migration failure
      ansible.builtin.debug:
        msg: >-
          Migration of generated content from NFS to local SSD failed.
          Immich services were stopped and may need manual restart.
          Check {{ immich_upload_dir }} and {{ immich_media_dir }} for partial state.

    - name: Fail with migration error
      ansible.builtin.fail:
        msg: "Immich NFS-to-local migration failed â€” manual intervention required"

# Create media subdirectories and mount-check marker files
# Immich verifies these on startup to detect unmounted volumes
- name: Create local media base directory
  ansible.builtin.file:
    path: "{{ immich_media_dir }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Create NFS media subdirectories
  ansible.builtin.file:
    path: "{{ immich_upload_dir }}/{{ item }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true
  become_user: "{{ mms_user }}"
  loop: "{{ immich_nfs_dirs }}"

- name: Create local media subdirectories
  ansible.builtin.file:
    path: "{{ immich_media_dir }}/{{ item }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true
  loop: "{{ immich_local_dirs }}"

- name: Create NFS mount-check marker files
  ansible.builtin.command:
    cmd: "touch {{ immich_upload_dir }}/{{ item }}/.immich"
    creates: "{{ immich_upload_dir }}/{{ item }}/.immich"
  become: true
  become_user: "{{ mms_user }}"
  loop: "{{ immich_nfs_dirs }}"

- name: Create local mount-check marker files
  ansible.builtin.command:
    cmd: "touch {{ immich_media_dir }}/{{ item }}/.immich"
    creates: "{{ immich_media_dir }}/{{ item }}/.immich"
  become: true
  become_user: "{{ mms_user }}"
  loop: "{{ immich_local_dirs }}"

# Flush handlers to ensure daemon-reload happens before starting services
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

# Enable and start services in dependency order
- name: Enable and start immich-postgres
  ansible.builtin.systemd:
    name: immich-postgres.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for PostgreSQL to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run immich-postgres
  register: _immich_pg_health
  until: _immich_pg_health.rc == 0
  retries: 12
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode

- name: Enable and start immich-redis
  ansible.builtin.systemd:
    name: immich-redis.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Redis to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run immich-redis
  register: _immich_redis_health
  until: _immich_redis_health.rc == 0
  retries: 12
  delay: 5
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode

- name: Enable and start immich-server
  ansible.builtin.systemd:
    name: immich-server.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Enable and start immich-ml
  ansible.builtin.systemd:
    name: immich-ml.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Immich server health check
  ansible.builtin.command:
    cmd: podman healthcheck run immich-server
  register: _immich_server_health
  until: _immich_server_health.rc == 0
  retries: 18
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode
