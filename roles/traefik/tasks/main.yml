---
- name: Create Traefik config directory
  ansible.builtin.file:
    path: "{{ traefik_config_dir }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Create Traefik dynamic config directory
  ansible.builtin.file:
    path: "{{ traefik_config_dir }}/dynamic"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Deploy Traefik static config
  ansible.builtin.template:
    src: traefik-static.yml.j2
    dest: "{{ traefik_config_dir }}/traefik.yml"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify: Restart traefik

- name: Deploy Traefik dynamic config
  ansible.builtin.template:
    src: traefik-dynamic.yml.j2
    dest: "{{ traefik_config_dir }}/dynamic/mms-routes.yml"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true

- name: Deploy Traefik container quadlet
  ansible.builtin.template:
    src: traefik.container.j2
    dest: "{{ mms_quadlet_dir }}/traefik.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart traefik

- name: Check if Traefik image is present
  ansible.builtin.command:
    cmd: "podman image exists {{ traefik_image }}"
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  register: _traefik_image_exists
  changed_when: false
  failed_when: false
  check_mode: false

- name: Pull Traefik image
  ansible.builtin.command:
    cmd: "podman pull {{ traefik_image }}"
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: _traefik_image_exists.rc != 0
  changed_when: true
  timeout: 900

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Enable and start Traefik
  ansible.builtin.systemd:
    name: traefik.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Traefik health check
  ansible.builtin.command:
    cmd: podman healthcheck run traefik
  register: _traefik_health
  until: _traefik_health.rc == 0
  retries: 12
  delay: 5
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode
