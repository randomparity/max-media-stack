---
- name: Create mms group
  ansible.builtin.group:
    name: "{{ base_system_user }}"
    gid: "{{ base_system_gid }}"
    state: present

- name: Create mms user
  ansible.builtin.user:
    name: "{{ base_system_user }}"
    uid: "{{ base_system_uid }}"
    group: "{{ base_system_user }}"
    shell: /bin/bash
    create_home: true
    state: present

- name: Create mms user bin directory
  ansible.builtin.file:
    path: "{{ base_system_home }}/bin"
    state: directory
    owner: "{{ base_system_user }}"
    group: "{{ base_system_user }}"
    mode: "0755"

- name: Deploy mms-services maintenance script
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/mms-services.sh.j2"
    dest: "{{ base_system_home }}/bin/mms-services"
    owner: "{{ base_system_user }}"
    group: "{{ base_system_user }}"
    mode: "0755"

- name: Enable loginctl linger for mms user
  ansible.builtin.command:
    cmd: loginctl enable-linger {{ base_system_user }}
    creates: /var/lib/systemd/linger/{{ base_system_user }}

- name: Create systemd user service drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/system/user@.service.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Delegate cgroup controllers to user sessions
  ansible.builtin.copy:
    dest: /etc/systemd/system/user@.service.d/delegate.conf
    owner: root
    group: root
    mode: "0644"
    content: |
      [Service]
      Delegate=cpu cpuset io memory pids
  notify: Reload systemd daemon

- name: Wait for cloud-init to finish
  ansible.builtin.command:
    cmd: cloud-init status --wait
  changed_when: false
  failed_when: false

- name: Clean stale dnf cache
  ansible.builtin.command:
    cmd: dnf clean all
  changed_when: false

- name: Install required packages
  ansible.builtin.dnf:
    name: "{{ base_system_packages }}"
    state: present

- name: Enable and start QEMU guest agent
  ansible.builtin.systemd:
    name: qemu-guest-agent
    enabled: true
    state: started

- name: Set timezone
  community.general.timezone:
    name: "{{ base_system_timezone }}"

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ base_system_hostname }}"

- name: Set SELinux booleans
  ansible.posix.seboolean:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    persistent: true
  loop: "{{ base_system_seboolean }}"

- name: Allow unprivileged port binding
  ansible.posix.sysctl:
    name: net.ipv4.ip_unprivileged_port_start
    value: "{{ base_system_sysctl_unprivileged_port_start }}"
    sysctl_file: /etc/sysctl.d/99-mms.conf
    reload: true
    state: present

# Persistent journal for centralized logging (Loki reads from /var/log/journal)
- name: Create persistent journal directory
  ansible.builtin.file:
    path: /var/log/journal
    state: directory
    owner: root
    group: systemd-journal
    mode: "2755"

- name: Create journald config directory
  ansible.builtin.file:
    path: /etc/systemd/journald.conf.d
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Deploy journald persistent storage config
  ansible.builtin.template:
    src: journald-mms.conf.j2
    dest: /etc/systemd/journald.conf.d/mms.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart journald
