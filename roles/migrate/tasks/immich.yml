---
- name: "immich - Stop Immich services on target"
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    scope: user
  loop:
    - immich-ml
    - immich-server
  become: true
  become_user: "{{ migrate_user }}"
  failed_when: false

- name: "immich - Dump PostgreSQL from source LXC"
  ansible.builtin.command:
    cmd: >-
      ssh {{ migrate_source_user }}@{{ migrate_source_host }}
      podman exec {{ migrate_immich_source_db_container }}
      pg_dumpall -U postgres
  register: _immich_source_dump
  changed_when: false
  delegate_to: localhost

- name: "immich - Write source dump to temp file"
  ansible.builtin.copy:
    content: "{{ _immich_source_dump.stdout }}"
    dest: /tmp/immich-migration-dump.sql
    mode: "0600"

- name: "immich - Copy dump into target PostgreSQL container"
  ansible.builtin.command:
    cmd: >-
      podman cp /tmp/immich-migration-dump.sql
      {{ migrate_immich_target_db_container }}:/tmp/immich-migration-dump.sql
  become: true
  become_user: "{{ migrate_user }}"

- name: "immich - Restore database on target"
  ansible.builtin.command:
    cmd: >-
      podman exec {{ migrate_immich_target_db_container }}
      psql -U postgres -f /tmp/immich-migration-dump.sql
  become: true
  become_user: "{{ migrate_user }}"
  register: _immich_restore
  changed_when: true

- name: "immich - Clean up dump files"
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/immich-migration-dump.sql

- name: "immich - Rsync photos from source LXC"
  ansible.builtin.command:
    cmd: >-
      rsync {{ migrate_rsync_opts }}
      {{ migrate_source_user }}@{{ migrate_source_host }}:{{ migrate_immich_source_photos }}/
      {{ migrate_immich_target_photos }}/
  register: _immich_photos_sync
  changed_when: _immich_photos_sync.rc == 0

- name: "immich - Fix photos ownership"
  ansible.builtin.file:
    path: "{{ migrate_immich_target_photos }}"
    owner: "{{ migrate_uid }}"
    group: "{{ migrate_gid }}"
    recurse: true
  become: true

- name: "immich - Rsync config from source LXC"
  ansible.builtin.command:
    cmd: >-
      rsync {{ migrate_rsync_opts }}
      {{ migrate_source_user }}@{{ migrate_source_host }}:{{ migrate_source_config_base }}/immich/
      {{ migrate_config_dir }}/immich/
  register: _immich_config_sync
  changed_when: _immich_config_sync.rc == 0

- name: "immich - Fix config ownership"
  ansible.builtin.file:
    path: "{{ migrate_config_dir }}/immich"
    owner: "{{ migrate_uid }}"
    group: "{{ migrate_gid }}"
    recurse: true
  become: true
