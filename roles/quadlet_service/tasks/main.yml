---
- name: Load service definition
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../services/{{ service_name }}.yml"

- name: Set service variable
  ansible.builtin.set_fact:
    service: "{{ lookup('vars', service_name) }}"

- name: Create config directory
  ansible.builtin.file:
    path: "{{ mms_config_dir }}/{{ service.name }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Deploy environment file
  ansible.builtin.copy:
    content: |
      {% for env in service.environment %}
      {{ env }}
      {% endfor %}
    dest: "{{ mms_config_dir }}/{{ service.name }}/{{ service.name }}.env"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  notify: Restart quadlet service

- name: Deploy container quadlet
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/quadlet/container.j2"
    dest: "{{ mms_quadlet_dir }}/{{ service.name }}.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart quadlet service

- name: Flush handlers before starting service
  ansible.builtin.meta: flush_handlers

- name: Enable and start service
  ansible.builtin.systemd:
    name: "{{ service.name }}.service"
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for service health check
  ansible.builtin.command:
    cmd: >-
      podman healthcheck run {{ service.name }}
  register: health_result
  until: health_result.rc == 0
  retries: "{{ (quadlet_health_timeout / quadlet_health_delay) | int }}"
  delay: "{{ quadlet_health_delay }}"
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: service.health_cmd is defined
