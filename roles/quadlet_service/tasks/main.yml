---
- name: Load service definition
  ansible.builtin.include_vars:
    file: "{{ playbook_dir }}/../services/{{ service_name }}.yml"

- name: Validate service definition key matches service_name
  ansible.builtin.assert:
    that:
      - lookup('vars', service_name, default='__missing__') != '__missing__'
    fail_msg: >-
      Service definition file services/{{ service_name }}.yml does not contain
      a top-level key '{{ service_name }}'. Check the file contents.

- name: Set service variable
  ansible.builtin.set_fact:
    quadlet_service_def: "{{ lookup('vars', service_name) }}"

- name: Create config directory
  ansible.builtin.file:
    path: "{{ mms_config_dir }}/{{ quadlet_service_def.name }}"
    state: directory
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0755"
  become: true

- name: Deploy environment file
  ansible.builtin.copy:
    content: |
      {% for env in quadlet_service_def.environment %}
      {{ env }}
      {% endfor %}
    dest: "{{ mms_config_dir }}/{{ quadlet_service_def.name }}/{{ quadlet_service_def.name }}.env"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0600"
  become: true
  notify: Restart quadlet service

- name: Deploy container quadlet
  ansible.builtin.template:
    src: "{{ playbook_dir }}/../templates/quadlet/container.j2"
    dest: "{{ mms_quadlet_dir }}/{{ quadlet_service_def.name }}.container"
    owner: "{{ mms_user }}"
    group: "{{ mms_user }}"
    mode: "0644"
  become: true
  notify:
    - Reload systemd user daemon
    - Restart quadlet service

- name: Flush handlers before starting service
  ansible.builtin.meta: flush_handlers

- name: Enable and start service
  ansible.builtin.systemd:
    name: "{{ quadlet_service_def.name }}.service"
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for service health check
  ansible.builtin.command:
    cmd: >-
      podman healthcheck run {{ quadlet_service_def.name }}
  register: quadlet_service_health_result
  until: quadlet_service_health_result.rc == 0
  retries: "{{ (quadlet_service_health_timeout / quadlet_service_health_delay) | int }}"
  delay: "{{ quadlet_service_health_delay }}"
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: quadlet_service_def.health_cmd is defined
