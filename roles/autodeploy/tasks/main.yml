---
- name: Ensure git is installed
  ansible.builtin.dnf:
    name: git
    state: present
  become: true
  become_user: root

- name: Grant mms user passwordless sudo for autodeploy
  ansible.builtin.copy:
    # Ansible become requires sudo for arbitrary commands per-task
    content: "{{ autodeploy_user }} ALL=(ALL) NOPASSWD: ALL\n"
    dest: "/etc/sudoers.d/mms-autodeploy"
    mode: "0440"
    validate: "visudo -cf %s"
  become: true
  become_user: root

- name: Ensure user bin directory exists
  ansible.builtin.file:
    path: "/home/{{ autodeploy_user }}/bin"
    state: directory
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0755"

- name: Ensure autodeploy log directory exists
  ansible.builtin.file:
    path: "{{ autodeploy_log_dir }}"
    state: directory
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0755"

- name: Ensure SSH directory exists
  ansible.builtin.file:
    path: "/home/{{ autodeploy_user }}/.ssh"
    state: directory
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0700"

- name: Deploy SSH deploy key
  ansible.builtin.copy:
    content: "{{ vault_autodeploy_ssh_key }}"
    dest: "/home/{{ autodeploy_user }}/.ssh/mms_deploy_key"
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0600"
  no_log: true
  when: vault_autodeploy_ssh_key is defined

- name: Configure SSH for GitHub deploy key
  ansible.builtin.blockinfile:
    path: "/home/{{ autodeploy_user }}/.ssh/config"
    create: true
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0600"
    marker: "# {mark} MMS AUTODEPLOY"
    block: |
      Host github.com
        IdentityFile ~/.ssh/mms_deploy_key
        StrictHostKeyChecking accept-new
  when: vault_autodeploy_ssh_key is defined

- name: Clone autodeploy repository
  ansible.builtin.git:
    repo: "{{ autodeploy_repo_url }}"
    dest: "{{ autodeploy_repo_dir }}"
    version: "{{ autodeploy_branch }}"
    accept_hostkey: true
  become: true
  become_user: "{{ autodeploy_user }}"
  when: autodeploy_repo_url | length > 0

- name: Install Galaxy collections into clone
  ansible.builtin.command:
    cmd: ansible-galaxy collection install -r requirements.yml --force
    chdir: "{{ autodeploy_repo_dir }}"
  become: true
  become_user: "{{ autodeploy_user }}"
  when: autodeploy_repo_url | length > 0
  changed_when: false

- name: Deploy vault password file
  ansible.builtin.copy:
    content: "{{ vault_mms_vault_password }}"
    dest: "{{ autodeploy_vault_password_file }}"
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0600"
  no_log: true
  when: vault_mms_vault_password is defined

- name: Deploy autodeploy script
  ansible.builtin.template:
    src: mms-autodeploy.sh.j2
    dest: "/home/{{ autodeploy_user }}/bin/mms-autodeploy.sh"
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0750"

- name: Ensure systemd user directory exists
  ansible.builtin.file:
    path: "/home/{{ autodeploy_user }}/.config/systemd/user"
    state: directory
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0755"

- name: Deploy systemd autodeploy service
  ansible.builtin.template:
    src: mms-autodeploy.service.j2
    dest: "/home/{{ autodeploy_user }}/.config/systemd/user/mms-autodeploy.service"
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0644"
  notify:
    - Reload systemd user daemon
    - Enable autodeploy timer

- name: Deploy systemd autodeploy timer
  ansible.builtin.template:
    src: mms-autodeploy.timer.j2
    dest: "/home/{{ autodeploy_user }}/.config/systemd/user/mms-autodeploy.timer"
    owner: "{{ autodeploy_user }}"
    group: "{{ autodeploy_user }}"
    mode: "0644"
  notify:
    - Reload systemd user daemon
    - Enable autodeploy timer
