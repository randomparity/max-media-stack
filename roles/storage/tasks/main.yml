---
- name: Create NFS mount points
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
  loop: "{{ storage_nfs_mounts }}"

- name: Mount NFS shares
  ansible.posix.mount:
    src: "{{ item.src }}"
    path: "{{ item.dest }}"
    fstype: nfs
    opts: "{{ item.opts }}"
    state: mounted
  loop: "{{ storage_nfs_mounts }}"

# The data directory and its local subdirectories (NFS mount point parents)
# have a default_t SELinux type that container_t cannot access. Set them to
# container_file_t so containers can traverse to the NFS mounts underneath,
# which are allowed separately via the virt_use_nfs boolean.
- name: Set persistent SELinux context on local data directories
  community.general.sefcontext:
    target: "{{ item }}"
    setype: container_file_t
    state: present
  loop:
    - "{{ storage_data_dir }}"
    - "{{ storage_data_dir }}/media"
  register: _storage_sefcontext

- name: Apply SELinux context to local data directories
  ansible.builtin.command:
    cmd: "restorecon -v {{ storage_data_dir }} {{ storage_data_dir }}/media"
  when: _storage_sefcontext is changed
  changed_when: true

# NFS directories: use become_user instead of owner/group/mode because
# NFS root_squash prevents root from setting file attributes.
# The mms user creates directories with its default umask.
- name: Create TRaSH-guide media directories
  ansible.builtin.file:
    path: "{{ storage_data_dir }}/media/{{ item }}"
    state: directory
  loop: "{{ storage_media_dirs }}"
  become: true
  become_user: "{{ storage_user }}"

- name: Create TRaSH-guide usenet directories
  ansible.builtin.file:
    path: "{{ storage_data_dir }}/usenet/{{ item }}"
    state: directory
  loop: "{{ storage_usenet_dirs }}"
  become: true
  become_user: "{{ storage_user }}"

- name: Create photos directory
  ansible.builtin.file:
    path: "{{ storage_data_dir }}/photos"
    state: directory
  become: true
  become_user: "{{ storage_user }}"

- name: Create config directories for each service
  ansible.builtin.file:
    path: "{{ storage_config_dir }}/{{ item }}"
    state: directory
    owner: "{{ storage_uid }}"
    group: "{{ storage_gid }}"
    mode: "0750"
  loop: "{{ storage_services + ['immich'] }}"

- name: Create backup staging directory
  ansible.builtin.file:
    path: "{{ storage_backup_dir }}"
    state: directory
    owner: "{{ storage_uid }}"
    group: "{{ storage_gid }}"
    mode: "0750"
