// {{ ansible_managed }}

// Read from systemd journal
loki.source.journal "mms" {
  path          = "/var/log/journal"
  relabel_rules = loki.relabel.journal.rules
  forward_to    = [loki.write.default.receiver]
  labels        = { job = "mms" }
}

// Extract and filter labels from journal entries
loki.relabel "journal" {
  forward_to = []

  // Extract the systemd user unit name
  rule {
    source_labels = ["__journal__systemd_user_unit"]
    target_label  = "unit"
  }

  // Extract container name
  rule {
    source_labels = ["__journal_container_name"]
    target_label  = "container"
  }

  // Extract service name (unit without .service suffix)
  rule {
    source_labels = ["__journal__systemd_user_unit"]
    regex         = `(.+)\.service`
    target_label  = "service_name"
  }

  // Keep only MMS-related units
  rule {
    source_labels = ["__journal__systemd_user_unit"]
    regex         = `({{ _logging_alloy_unit_filter }})`
    action        = "keep"
  }
}

// Ship logs to Loki
loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}

// Expose host metrics for Prometheus scraping
prometheus.exporter.unix "host" {
  procfs_path = "/host/proc"
  sysfs_path  = "/host/sys"
  rootfs_path = "/host/root"
  set_collectors = ["cpu", "diskstats", "filesystem", "loadavg", "meminfo", "netdev", "vmstat"]
}
