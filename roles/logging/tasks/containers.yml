---
# Pull images before starting services to avoid systemd timeout on first boot
- name: Check if logging images are present
  ansible.builtin.command:
    cmd: "podman image exists {{ item }}"
  loop:
    - "{{ logging_loki_image }}"
    - "{{ logging_alloy_image }}"
    - "{{ logging_grafana_image }}"
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  register: _logging_images
  changed_when: false
  failed_when: false
  check_mode: false

- name: Pull missing logging images
  ansible.builtin.command:
    cmd: "podman pull {{ item.item }}"
  loop: "{{ _logging_images.results }}"
  loop_control:
    label: "{{ item.item }}"
  when: item.rc != 0
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  changed_when: true
  timeout: 1800

# Flush handlers to ensure daemon-reload happens before starting services
- name: Flush handlers
  ansible.builtin.meta: flush_handlers

# Enable and start services in dependency order
- name: Enable and start Loki
  ansible.builtin.systemd:
    name: loki.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Loki to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run loki
  register: _loki_health
  until: _loki_health.rc == 0
  retries: 12
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode

- name: Enable and start Alloy
  ansible.builtin.systemd:
    name: alloy.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Alloy to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run alloy
  register: _alloy_health
  until: _alloy_health.rc == 0
  retries: 12
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode

- name: Enable and start Grafana
  ansible.builtin.systemd:
    name: grafana.service
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"

- name: Wait for Grafana to be ready
  ansible.builtin.command:
    cmd: podman healthcheck run grafana
  register: _grafana_health
  until: _grafana_health.rc == 0
  retries: 12
  delay: 10
  changed_when: false
  become: true
  become_user: "{{ mms_user }}"
  environment: "{{ mms_systemd_env }}"
  when: not ansible_check_mode
