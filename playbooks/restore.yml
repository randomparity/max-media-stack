---
- name: Restore an MMS service from backup
  hosts: mms
  become: true
  become_user: "{{ mms_user }}"

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - service_name is defined
          - service_name | length > 0
          - backup_file is defined
          - backup_file | length > 0
        fail_msg: "You must specify -e service_name=<name> -e backup_file=<path>"

    - name: Verify backup file exists
      ansible.builtin.stat:
        path: "{{ backup_file }}"
      register: _backup_stat

    - name: Fail if backup file not found
      ansible.builtin.assert:
        that: _backup_stat.stat.exists
        fail_msg: "Backup file not found: {{ backup_file }}"

    - name: Validate age identity file for encrypted backups
      ansible.builtin.assert:
        that:
          - backup_age_identity_file | length > 0
        fail_msg: "backup_age_identity_file is required for encrypted backups. Use -e backup_age_identity_file=/path/to/key"
      when: backup_file is match('.*\\.age$')

  tasks:
    - name: Restore standard service  # noqa: no-relative-paths
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/backup/tasks/restore_service.yml"
      vars:
        _restore_label: "{{ service_name }}"
        _restore_tmp_ext: tar.zst
        _restore_service: "{{ service_name }}"
        _restore_cmd: "zstd -d {{ backup_restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}"
      when: service_name in ['prowlarr', 'radarr', 'radarr4k', 'sonarr', 'lidarr', 'jellyfin']

    - name: Restore sabnzbd  # noqa: no-relative-paths
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/backup/tasks/restore_service.yml"
      vars:
        _restore_label: sabnzbd
        _restore_tmp_ext: tar.zst
        _restore_service: sabnzbd
        _restore_cmd: "zstd -d {{ backup_restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}/sabnzbd"
      when: service_name == 'sabnzbd'

    - name: Restore immich database  # noqa: no-relative-paths
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/backup/tasks/restore_service.yml"
      vars:
        _restore_label: immich-db
        _restore_tmp_ext: sql.zst
        _restore_service: ""
        _restore_cmd: >-
          zstd -d {{ backup_restore_file }} --stdout |
          podman exec -i immich-postgres psql -U postgres
      when: service_name == 'immich' and 'db' in backup_file

    - name: Restore immich config  # noqa: no-relative-paths
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/backup/tasks/restore_service.yml"
      vars:
        _restore_label: immich-config
        _restore_tmp_ext: tar.zst
        _restore_service: ""
        _restore_cmd: "zstd -d {{ backup_restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}"
      when: service_name == 'immich' and 'config' in backup_file

    - name: Stop open-notebook services before restore
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: stopped
        scope: user
      environment: "{{ mms_systemd_env }}"
      loop:
        - open-notebook
        - open-notebook-db
      when: service_name == 'open-notebook'
      failed_when: false

    - name: Restore open-notebook  # noqa: no-relative-paths
      ansible.builtin.include_tasks:
        file: "{{ playbook_dir }}/../roles/backup/tasks/restore_service.yml"
      vars:
        _restore_label: open-notebook
        _restore_tmp_ext: tar.zst
        _restore_service: ""
        _restore_cmd: "zstd -d {{ backup_restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}"
      when: service_name == 'open-notebook'

    - name: Fix ownership after open-notebook restore
      ansible.builtin.file:
        path: "{{ mms_config_dir }}/{{ item }}"
        state: directory
        owner: "{{ mms_user }}"
        group: "{{ mms_user }}"
        recurse: true
      become: true
      become_user: root
      loop:
        - open-notebook
        - open-notebook-db
      when: service_name == 'open-notebook'

    - name: Start open-notebook services after restore
      ansible.builtin.systemd:
        name: "{{ item }}"
        state: started
        scope: user
      environment: "{{ mms_systemd_env }}"
      loop:
        - open-notebook-db
        - open-notebook
      when: service_name == 'open-notebook'

    - name: Fix ownership after restore
      ansible.builtin.file:
        path: "{{ mms_config_dir }}/{{ service_name }}"
        state: directory
        owner: "{{ mms_user }}"
        group: "{{ mms_user }}"
        recurse: true
      become: true
      become_user: root
      when: service_name != 'open-notebook'
