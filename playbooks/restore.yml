---
- name: Restore an MMS service from backup
  hosts: mms
  become: true
  become_user: "{{ mms_user }}"

  pre_tasks:
    - name: Validate required variables
      ansible.builtin.assert:
        that:
          - service_name is defined
          - service_name | length > 0
          - backup_file is defined
          - backup_file | length > 0
        fail_msg: "You must specify -e service_name=<name> -e backup_file=<path>"

    - name: Verify backup file exists
      ansible.builtin.stat:
        path: "{{ backup_file }}"
      register: _backup_stat

    - name: Fail if backup file not found
      ansible.builtin.assert:
        that: _backup_stat.stat.exists
        fail_msg: "Backup file not found: {{ backup_file }}"

    - name: Validate age identity file for encrypted backups
      ansible.builtin.assert:
        that:
          - backup_age_identity_file | length > 0
        fail_msg: "backup_age_identity_file is required for encrypted backups. Use -e backup_age_identity_file=/path/to/key"
      when: backup_file is match('.*\\.age$')

  tasks:
    - name: Restore arr service
      when: service_name in ['prowlarr', 'radarr', 'sonarr', 'lidarr']
      block:
        - name: Stop arr service
          ansible.builtin.systemd:
            name: "{{ service_name }}"
            state: stopped
            scope: user

        - name: Decrypt backup if encrypted
          ansible.builtin.command:
            cmd: "age -d -i {{ backup_age_identity_file }} -o /tmp/restore-{{ service_name }}.tar.zst {{ backup_file }}"
          when: backup_file is match('.*\\.age$')

        - name: Set restore file path
          ansible.builtin.set_fact:
            _restore_file: "{{ '/tmp/restore-' + service_name + '.tar.zst' if backup_file is match('.*\\.age$') else backup_file }}"

        - name: Extract backup
          ansible.builtin.command:
            cmd: "bash -c 'zstd -d {{ _restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}'"

        - name: Start arr service
          ansible.builtin.systemd:
            name: "{{ service_name }}"
            state: started
            scope: user

        - name: Clean up temp file
          ansible.builtin.file:
            path: "/tmp/restore-{{ service_name }}.tar.zst"
            state: absent
          when: backup_file is match('.*\\.age$')

    - name: Restore sabnzbd
      when: service_name == 'sabnzbd'
      block:
        - name: Stop sabnzbd
          ansible.builtin.systemd:
            name: sabnzbd
            state: stopped
            scope: user

        - name: Decrypt backup if encrypted
          ansible.builtin.command:
            cmd: "age -d -i {{ backup_age_identity_file }} -o /tmp/restore-sabnzbd.tar.zst {{ backup_file }}"
          when: backup_file is match('.*\\.age$')

        - name: Set restore file path
          ansible.builtin.set_fact:
            _restore_file: "{{ '/tmp/restore-sabnzbd.tar.zst' if backup_file is match('.*\\.age$') else backup_file }}"

        - name: Extract backup
          ansible.builtin.command:
            cmd: "bash -c 'zstd -d {{ _restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}/sabnzbd'"

        - name: Start sabnzbd
          ansible.builtin.systemd:
            name: sabnzbd
            state: started
            scope: user

    - name: Restore jellyfin
      when: service_name == 'jellyfin'
      block:
        - name: Stop jellyfin
          ansible.builtin.systemd:
            name: jellyfin
            state: stopped
            scope: user

        - name: Decrypt backup if encrypted
          ansible.builtin.command:
            cmd: "age -d -i {{ backup_age_identity_file }} -o /tmp/restore-jellyfin.tar.zst {{ backup_file }}"
          when: backup_file is match('.*\\.age$')

        - name: Set restore file path
          ansible.builtin.set_fact:
            _restore_file: "{{ '/tmp/restore-jellyfin.tar.zst' if backup_file is match('.*\\.age$') else backup_file }}"

        - name: Extract backup excluding cache
          ansible.builtin.command:
            cmd: "bash -c 'zstd -d {{ _restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}'"

        - name: Start jellyfin
          ansible.builtin.systemd:
            name: jellyfin
            state: started
            scope: user

    - name: Restore immich database
      when: service_name == 'immich' and 'db' in backup_file
      block:
        - name: Decrypt backup if encrypted
          ansible.builtin.command:
            cmd: "age -d -i {{ backup_age_identity_file }} -o /tmp/restore-immich-db.sql.zst {{ backup_file }}"
          when: backup_file is match('.*\\.age$')

        - name: Set restore file path
          ansible.builtin.set_fact:
            _restore_file: "{{ '/tmp/restore-immich-db.sql.zst' if backup_file is match('.*\\.age$') else backup_file }}"

        - name: Decompress and restore database
          ansible.builtin.shell:
            cmd: "zstd -d {{ _restore_file }} --stdout | podman exec -i immich-postgres psql -U postgres"

    - name: Restore immich config
      when: service_name == 'immich' and 'config' in backup_file
      block:
        - name: Decrypt backup if encrypted
          ansible.builtin.command:
            cmd: "age -d -i {{ backup_age_identity_file }} -o /tmp/restore-immich-config.tar.zst {{ backup_file }}"
          when: backup_file is match('.*\\.age$')

        - name: Set restore file path
          ansible.builtin.set_fact:
            _restore_file: "{{ '/tmp/restore-immich-config.tar.zst' if backup_file is match('.*\\.age$') else backup_file }}"

        - name: Extract config backup
          ansible.builtin.command:
            cmd: "bash -c 'zstd -d {{ _restore_file }} --stdout | tar -xf - -C {{ mms_config_dir }}'"

    - name: Fix ownership after restore
      ansible.builtin.command:
        cmd: "chown -R {{ mms_user }}:{{ mms_user }} {{ mms_config_dir }}/{{ service_name }}"
      become: true
      become_user: root
      changed_when: true
