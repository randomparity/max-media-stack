---
- name: Deploy all MMS services
  hosts: mms
  become: true

  environment: "{{ mms_systemd_env }}"

  tasks:
    - name: Set effective service list  # noqa: var-naming[no-role-prefix]
      ansible.builtin.set_fact:
        _effective_quadlet_services: >-
          {{ mms_services | intersect(deploy_services)
             if deploy_services is defined
             else mms_services }}
        _deploy_immich: "{{ (deploy_services is not defined) or ('immich' in deploy_services) }}"
        _deploy_traefik: "{{ (deploy_services is not defined) or ('traefik' in deploy_services) }}"

    - name: Deploy each service
      ansible.builtin.include_tasks:
        file: tasks/deploy-one-service.yml
      vars:
        service_name: "{{ item }}"
      loop: "{{ _effective_quadlet_services }}"

    - name: Deploy Immich stack
      block:
        - name: Include immich role
          ansible.builtin.include_role:
            name: immich
      rescue:
        - name: Record Immich failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['immich'] }}"
        - name: Warn about Immich failure
          ansible.builtin.debug:
            msg: "Immich stack failed to deploy — continuing with remaining services"
      when: _deploy_immich | bool

    - name: Deploy Traefik reverse proxy
      block:
        - name: Include traefik role
          ansible.builtin.include_role:
            name: traefik
      rescue:
        - name: Record Traefik failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['traefik'] }}"
        - name: Warn about Traefik failure
          ansible.builtin.debug:
            msg: "Traefik failed to deploy — continuing with remaining tasks"
      when: _deploy_traefik | bool

    - name: Fail if any services failed to deploy
      ansible.builtin.fail:
        msg: "The following services failed to deploy: {{ _failed_services | join(', ') }}"
      when: _failed_services is defined and _failed_services | length > 0
