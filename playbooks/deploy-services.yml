---
- name: Deploy all MMS services
  hosts: mms
  become: true

  environment: "{{ mms_systemd_env }}"

  tasks:
    - name: Set effective service list  # noqa: var-naming[no-role-prefix]
      ansible.builtin.set_fact:
        _effective_quadlet_services: >-
          {{ mms_services | intersect(deploy_services)
             if deploy_services is defined
             else mms_services }}
        _deploy_immich: "{{ (deploy_services is not defined) or ('immich' in deploy_services) }}"
        _deploy_open_notebook: "{{ (deploy_services is not defined) or ('open-notebook' in deploy_services) }}"
        _deploy_traefik: "{{ (deploy_services is not defined) or ('traefik' in deploy_services) }}"
        _deploy_logging: "{{ (deploy_services is not defined) or ('logging' in deploy_services) }}"

    - name: Deploy each service
      ansible.builtin.include_tasks:
        file: tasks/deploy-one-service.yml
      vars:
        service_name: "{{ item }}"
      loop: "{{ _effective_quadlet_services }}"

    - name: Deploy Immich stack
      when: _deploy_immich | bool
      block:
        - name: Include immich role
          ansible.builtin.include_role:
            name: immich
      rescue:
        - name: Record Immich failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['immich'] }}"
        - name: Warn about Immich failure
          ansible.builtin.debug:
            msg: "Immich stack failed to deploy — continuing with remaining services"

    - name: Deploy Open Notebook stack
      when: _deploy_open_notebook | bool
      block:
        - name: Include open_notebook role
          ansible.builtin.include_role:
            name: open_notebook
      rescue:
        - name: Record Open Notebook failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['open-notebook'] }}"
        - name: Warn about Open Notebook failure
          ansible.builtin.debug:
            msg: "Open Notebook stack failed to deploy — continuing with remaining services"

    - name: Deploy Traefik reverse proxy
      when: _deploy_traefik | bool
      block:
        - name: Include traefik role
          ansible.builtin.include_role:
            name: traefik
      rescue:
        - name: Record Traefik failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['traefik'] }}"
        - name: Warn about Traefik failure
          ansible.builtin.debug:
            msg: "Traefik failed to deploy — continuing with remaining tasks"

    - name: Deploy logging stack
      when: _deploy_logging | bool
      block:
        - name: Include logging role
          ansible.builtin.include_role:
            name: logging
      rescue:
        - name: Record logging failure
          ansible.builtin.set_fact:
            _failed_services: "{{ _failed_services | default([]) + ['logging'] }}"
        - name: Warn about logging failure
          ansible.builtin.debug:
            msg: "Logging stack failed to deploy — continuing with remaining tasks"

    - name: Fail if any services failed to deploy
      ansible.builtin.fail:
        msg: "The following services failed to deploy: {{ _failed_services | join(', ') }}"
      when: _failed_services is defined and _failed_services | length > 0
