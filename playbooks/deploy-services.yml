---
- name: Deploy all MMS services
  hosts: mms
  become: true

  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ mms_uid }}"
    DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ mms_uid }}/bus"

  tasks:
    - name: Ensure mms.network quadlet is deployed
      ansible.builtin.template:
        src: "{{ playbook_dir }}/../templates/quadlet/network.j2"
        dest: "{{ mms_quadlet_dir }}/{{ mms_network_name }}.network"
        owner: "{{ mms_user }}"
        group: "{{ mms_user }}"
        mode: "0644"
      register: _network_quadlet

    - name: Reload systemd user daemon for network
      ansible.builtin.systemd:
        daemon_reload: true
        scope: user
      become_user: "{{ mms_user }}"
      when: _network_quadlet.changed

    - name: Start shared network
      ansible.builtin.systemd:
        name: "{{ mms_network_name }}-network"
        state: started
        scope: user
        enabled: true
      become_user: "{{ mms_user }}"

    - name: Deploy each service
      ansible.builtin.include_role:
        name: quadlet_service
      vars:
        service_name: "{{ item }}"
      loop: "{{ mms_services }}"

    - name: Deploy Immich stack
      ansible.builtin.include_role:
        name: immich
