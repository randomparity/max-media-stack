#!/bin/bash
# {{ ansible_managed }}
# Maintenance script for MMS container services

set -euo pipefail

QUADLET_DIR="{{ mms_quadlet_dir }}"
FAILURES=0
{% raw %}
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
RESET='\033[0m'

usage() {
    echo "Usage: mms-services {start|stop|restart|status}"
    echo
    echo "Manage all MMS container services."
    echo
    echo "Commands:"
    echo "  start    Start all services in dependency order"
    echo "  stop     Stop all services in reverse dependency order"
    echo "  restart  Stop then start all services"
    echo "  status   Show status of all services"
    exit 1
}

# Discover services from Quadlet .container files
discover_services() {
    local services=()
    for f in "$QUADLET_DIR"/*.container; do
        [[ -e "$f" ]] || continue
        services+=("$(basename "$f" .container)")
    done
    if [[ ${#services[@]} -eq 0 ]]; then
        echo -e "${RED}No container services found in ${QUADLET_DIR}${RESET}" >&2
        exit 1
    fi
    echo "${services[@]}"
}

# Categorize a service into a tier (0=infra, 1=immich-app, 2=app, 3=proxy)
get_tier() {
    local svc="$1"
    case "$svc" in
        immich-postgres|immich-redis|open-notebook-db|loki) echo 0 ;;
        immich-server|immich-ml)      echo 1 ;;
        traefik)                      echo 3 ;;
        *)                            echo 2 ;;
    esac
}

tier_label() {
    case "$1" in
        0) echo "infra" ;;
        1) echo "immich-app" ;;
        2) echo "app" ;;
        3) echo "proxy" ;;
    esac
}

# Sort services into tier buckets
# Sets global arrays: TIER_0, TIER_1, TIER_2, TIER_3
categorize_services() {
    TIER_0=() TIER_1=() TIER_2=() TIER_3=()
    local all_services
    read -ra all_services <<< "$(discover_services)"
    for svc in "${all_services[@]}"; do
        local tier
        tier=$(get_tier "$svc")
        case "$tier" in
            0) TIER_0+=("$svc") ;;
            1) TIER_1+=("$svc") ;;
            2) TIER_2+=("$svc") ;;
            3) TIER_3+=("$svc") ;;
        esac
    done
}

do_action() {
    local action="$1"
    shift
    local services=("$@")

    if [[ ${#services[@]} -eq 0 ]]; then
        return
    fi

    local gerund
    case "$action" in
        start)   gerund="Starting" ;;
        stop)    gerund="Stopping" ;;
        restart) gerund="Restarting" ;;
        *)       gerund="${action}ing" ;;
    esac

    local tier
    tier=$(get_tier "${services[0]}")
    local label
    label=$(tier_label "$tier")
    echo -e "${BLUE}${BOLD}[$label]${RESET} ${gerund}: ${services[*]}"

    for svc in "${services[@]}"; do
        if systemctl --user "$action" "$svc.service"; then
            echo -e "  ${GREEN}✓${RESET} $svc"
        else
            echo -e "  ${RED}✗${RESET} $svc"
            ((FAILURES++)) || true
        fi
    done
}

cmd_start() {
    categorize_services
    FAILURES=0
    echo -e "${BOLD}Starting all MMS services...${RESET}"
    echo
    do_action start "${TIER_0[@]}"
    do_action start "${TIER_1[@]}"
    do_action start "${TIER_2[@]}"
    do_action start "${TIER_3[@]}"
    echo
    if [[ $FAILURES -gt 0 ]]; then
        echo -e "${RED}${BOLD}Start completed with ${FAILURES} failure(s).${RESET}"
        exit 1
    fi
    echo -e "${GREEN}${BOLD}Start complete.${RESET}"
}

cmd_stop() {
    categorize_services
    FAILURES=0
    echo -e "${BOLD}Stopping all MMS services...${RESET}"
    echo
    do_action stop "${TIER_3[@]}"
    do_action stop "${TIER_2[@]}"
    do_action stop "${TIER_1[@]}"
    do_action stop "${TIER_0[@]}"
    echo
    if [[ $FAILURES -gt 0 ]]; then
        echo -e "${RED}${BOLD}Stop completed with ${FAILURES} failure(s).${RESET}"
        exit 1
    fi
    echo -e "${GREEN}${BOLD}Stop complete.${RESET}"
}

cmd_restart() {
    local stop_failures=0 start_failures=0
    categorize_services
    FAILURES=0
    echo -e "${BOLD}Stopping all MMS services...${RESET}"
    echo
    do_action stop "${TIER_3[@]}"
    do_action stop "${TIER_2[@]}"
    do_action stop "${TIER_1[@]}"
    do_action stop "${TIER_0[@]}"
    stop_failures=$FAILURES
    echo
    FAILURES=0
    echo -e "${BOLD}Starting all MMS services...${RESET}"
    echo
    do_action start "${TIER_0[@]}"
    do_action start "${TIER_1[@]}"
    do_action start "${TIER_2[@]}"
    do_action start "${TIER_3[@]}"
    start_failures=$FAILURES
    echo
    FAILURES=$((stop_failures + start_failures))
    if [[ $FAILURES -gt 0 ]]; then
        echo -e "${RED}${BOLD}Restart completed with ${FAILURES} failure(s).${RESET}"
        exit 1
    fi
    echo -e "${GREEN}${BOLD}Restart complete.${RESET}"
}

cmd_status() {
    local all_services
    read -ra all_services <<< "$(discover_services)"

    local units=()
    for svc in "${all_services[@]}"; do
        units+=("$svc.service")
    done

    echo -e "${BOLD}MMS Service Status${RESET}"
    echo
    systemctl --user status --no-pager "${units[@]}" 2>/dev/null || true
}

if [[ $# -ne 1 ]]; then
    usage
fi

case "$1" in
    start)   cmd_start ;;
    stop)    cmd_stop ;;
    restart) cmd_restart ;;
    status)  cmd_status ;;
    *)       usage ;;
esac
{% endraw %}
