{{ ansible_managed | comment }}

[Unit]
Description={{ quadlet_service_def.description }}
After=network-online.target
{% if quadlet_service_def.after is defined %}
{% for dep in quadlet_service_def.after %}
After={{ dep }}
{% endfor %}
{% endif %}

[Container]
ContainerName={{ quadlet_service_def.name }}
Image={{ quadlet_service_def.image }}
UserNS=keep-id
{% if quadlet_service_def.user is defined %}
User={{ quadlet_service_def.user }}
{% endif %}
Network={{ mms_network_name }}.network
{% if quadlet_service_def.publish_ports is defined %}
{% for port in quadlet_service_def.publish_ports %}
PublishPort={{ port }}
{% endfor %}
{% endif %}
{% for vol in quadlet_service_def.volumes %}
Volume={{ vol }}
{% endfor %}
EnvironmentFile={{ mms_config_dir }}/{{ quadlet_service_def.name }}/{{ quadlet_service_def.name }}.env
{% if quadlet_service_def.health_cmd is defined %}
HealthCmd={{ quadlet_service_def.health_cmd }}
HealthInterval={{ quadlet_service_def.health_interval | default('60s') }}
{% endif %}
{% if quadlet_service_def.secrets is defined %}
{% for secret in quadlet_service_def.secrets %}
Secret={{ secret }}
{% endfor %}
{% endif %}
Tmpfs=/run:U
{% for tmpfs in quadlet_service_def.tmpfs | default([]) %}
Tmpfs={{ tmpfs }}
{% endfor %}
NoNewPrivileges={{ quadlet_service_def.no_new_privileges | default(true) | bool | lower }}
{% if quadlet_service_def.auto_update | default(false) %}
AutoUpdate=registry
{% endif %}

[Service]
Restart=on-failure
TimeoutStartSec=300

[Install]
WantedBy=default.target
